<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Demo</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <base href="/"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/4.3.1/css/bootstrap.min.css"/>
    <script type="text/javascript" src="/webjars/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>
<body>
<h1>Demo</h1>
<div class="container"></div>
<div class="container unauthenticated">
    With GitHub: <a href="/oauth2/authorization/github">click here</a>
</div>
<div class="container authenticated" style="display:none">
    Logged in as: <span id="user"></span>
    <a href="/logout" id="logout">Logout</a>
</div>
<script type="text/javascript">
    // After OAuth2 login, the server redirects here with ?token=<jwt>
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (token) {
        localStorage.setItem('jwt_token', token);
        window.history.replaceState({}, document.title, '/');
    }

    // Use the stored JWT to fetch the current user
    const storedToken = localStorage.getItem('jwt_token');
    if (storedToken) {
        $.ajax({
            url: '/user',
            headers: { 'Authorization': 'Bearer ' + storedToken },
            success: function(data) {
                $('#user').html(data.name);
                $('.unauthenticated').hide();
                $('.authenticated').show();
            },
            error: function() {
                localStorage.removeItem('jwt_token');
            }
        });
        $('#logout').click(function() {
                localStorage.removeItem('jwt_token');
        });
    }
</script>
</body>
</html>
